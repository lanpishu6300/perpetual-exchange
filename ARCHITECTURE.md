# 架构设计文档

## 概述

本项目是一个高性能永续合约交易所核心引擎，专注于纳秒级延迟优化。设计参考了Binance、Deribit、OKX等业界领先交易所的最佳实践。

## 核心组件

### 1. 订单簿 (OrderBook)

#### 数据结构
- **红黑树**: 用于维护价格优先级，保证O(log n)的插入、删除和查询操作
- **价格层级聚合**: 相同价格的订单聚合在一起，减少内存占用
- **双向链表**: 在价格层级内维护订单的时间顺序

#### 关键特性
- 买单簿：价格从高到低排序（最高价最优）
- 卖单簿：价格从低到高排序（最低价最优）
- 价格相同时，按时间戳排序（时间优先）

### 2. 撮合引擎 (MatchingEngine)

#### 撮合算法
1. **价格时间优先** (Price-Time Priority)
   - 价格优先：最优价格优先撮合
   - 时间优先：相同价格按时间戳排序

2. **订单类型支持**
   - 限价单 (LIMIT): 指定价格，未完全成交时挂单
   - 市价单 (MARKET): 以最优价格立即成交
   - IOC (Immediate or Cancel): 立即成交，未成交部分取消
   - FOK (Fill or Kill): 全部成交或全部取消

#### 撮合流程
```
1. 接收订单
2. 验证订单（价格、数量、用户权限等）
3. 匹配订单（与对手盘订单匹配）
   - 检查价格兼容性
   - 计算成交价格（价格时间优先）
   - 确定成交数量
   - 执行成交
4. 更新订单状态
5. 更新订单簿
6. 触发回调（成交、订单更新）
```

### 3. 仓位管理 (Position)

#### 仓位模式
- **双向持仓**: 支持同时持有多头和空头仓位
- **净持仓**: 自动计算净持仓大小（多仓 - 空仓）

#### 关键计算
- **平均开仓价**: 加权平均计算
  - 开仓时：`新平均价 = (原持仓成本 + 新开仓成本) / 总持仓`
  - 平仓时：按FIFO或指定仓位平仓

- **未实现盈亏**:
  - 线性合约: `PnL = 持仓量 × (标记价格 - 开仓价)`
  - 反向合约: `PnL = 持仓量 × (1/开仓价 - 1/标记价格)`

- **保证金**: `保证金 = 名义价值 / 杠杆`
  - `名义价值 = 持仓量 × 标记价格 × 合约乘数`

### 4. 账户管理 (Account)

#### 账户结构
- **余额**: 总余额、可用余额、冻结余额
- **保证金**: 已用保证金、可用保证金
- **盈亏**: 已实现盈亏、未实现盈亏

#### 资金流
```
充值 → 总余额增加
下单 → 冻结余额增加（保证金 + 手续费）
成交 → 冻结余额减少，更新盈亏
撤单 → 冻结余额释放
```

### 5. 资金费率 (Funding Rate)

#### 计算机制
1. **溢价指数**: `(标记价格 - 指数价格) / 指数价格`
2. **资金费率**: `溢价指数 × 资金费率系数`
3. **资金费用**: `持仓量 × 标记价格 × 资金费率`

#### 资金费率方向
- **多头持仓**: 支付资金费用（资金费率为正时）
- **空头持仓**: 收取资金费用（资金费率为正时）

### 6. 风险控制

#### 强制平仓
- **维持保证金率**: 账户权益 / 已用保证金
- **强制平仓条件**: 维持保证金率 < 维持保证金要求

#### 强制平仓价格
- **多仓**: `强制平仓价 = 开仓价 × (1 - 1/杠杆 + 维持保证金率)`
- **空仓**: `强制平仓价 = 开仓价 × (1 + 1/杠杆 - 维持保证金率)`

## 性能优化

### 数据结构优化
1. **定点数**: 使用整数类型存储价格和数量，避免浮点运算
   - 价格精度: 10^9 (9位小数)
   - 数量精度: 10^6 (6位小数)

2. **缓存对齐**: 订单结构对齐到64字节（CPU缓存行）
   ```cpp
   struct alignas(64) Order { ... };
   ```

3. **内存池**: 减少动态内存分配（待实现）

### 算法优化
1. **红黑树**: 保证O(log n)的操作复杂度
2. **价格层级预聚合**: 减少订单遍历次数
3. **最小化锁**: 仅在必要时使用锁，提高并发性能

### 延迟优化
1. **内联函数**: 关键路径函数内联
2. **分支预测**: 优化条件分支
3. **SIMD指令**: 批量计算（待实现）
4. **零拷贝**: 减少数据复制（待实现）

## 扩展性设计

### 水平扩展
- 按交易对分区（每个交易对独立的撮合引擎）
- 按用户ID分区（账户和仓位管理）

### 持久化
- 订单快照（定期保存订单簿状态）
- 交易日志（所有成交记录）
- 订单日志（所有订单变更记录）

### 容灾
- 主备切换
- 数据复制
- 一致性检查

## 参考设计

### Binance
- 价格时间优先撮合
- 订单簿深度管理
- 高效的订单匹配算法

### Deribit
- 永续合约资金费率机制
- 期权相关的风险控制

### OKX
- 多层级订单簿
- 深度聚合算法
- 实时行情推送

### Bybit
- 风险控制和强制平仓
- 标记价格机制
- 资金费率计算

## 未来优化方向

1. **内存池**: 实现高效的内存池，减少分配开销
2. **无锁数据结构**: 使用无锁队列和原子操作
3. **SIMD优化**: 批量计算优化
4. **NUMA感知**: 针对多CPU架构优化
5. **FPGA加速**: 关键路径硬件加速（长期）



