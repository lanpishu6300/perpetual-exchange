#!/bin/bash

echo "=========================================="
echo "ç”Ÿæˆæ–°ç‰ˆæ€§èƒ½å‹æµ‹æŠ¥å‘Š"
echo "=========================================="
echo ""

PROJECT_ROOT="/Users/lan/Downloads/perpetual_exchange"
BUILD_DIR="$PROJECT_ROOT/build"
REPORT_FILE="$PROJECT_ROOT/PERFORMANCE_BENCHMARK_REPORT_$(date +%Y%m%d_%H%M%S).md"

# æ£€æŸ¥æ„å»ºç›®å½•
if [ ! -d "$BUILD_DIR" ]; then
    echo "æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸­..."
    mkdir -p "$BUILD_DIR"
fi

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
cat > "$REPORT_FILE" << 'EOFREPORT'
# æ°¸ç»­åˆçº¦äº¤æ˜“ç³»ç»Ÿæ€§èƒ½å‹æµ‹æŠ¥å‘Š

## æµ‹è¯•æ—¶é—´
$(date '+%Y-%m-%d %H:%M:%S')

## æµ‹è¯•ç¯å¢ƒ

### ç¡¬ä»¶é…ç½®
- **CPU**: $(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "Unknown")
- **CPUæ ¸å¿ƒæ•°**: $(sysctl -n hw.ncpu 2>/dev/null || echo "Unknown")
- **å†…å­˜**: $(sysctl -n hw.memsize 2>/dev/null | awk '{printf "%.2f GB", $1/1024/1024/1024}' || echo "Unknown")
- **æ“ä½œç³»ç»Ÿ**: $(uname -s) $(uname -r)

### è½¯ä»¶é…ç½®
- **ç¼–è¯‘å™¨**: $(g++ --version | head -1)
- **ä¼˜åŒ–çº§åˆ«**: -O3
- **SIMDæ”¯æŒ**: AVX2 (256-bit)

## æµ‹è¯•æ–¹æ³•

### 1. è®¢å•æ’®åˆæ€§èƒ½æµ‹è¯•

æµ‹è¯•ä¸åŒè®¢å•ç±»å‹çš„æ’®åˆæ€§èƒ½ï¼š
- é™ä»·å•æ’®åˆ
- å¸‚ä»·å•æ’®åˆ
- æ‰¹é‡è®¢å•æ’®åˆ

### 2. äº‹ä»¶æº¯æºæ€§èƒ½æµ‹è¯•

æµ‹è¯•äº‹ä»¶å­˜å‚¨å’Œé‡æ”¾çš„æ€§èƒ½ï¼š
- äº‹ä»¶å†™å…¥æ€§èƒ½
- äº‹ä»¶é‡æ”¾æ€§èƒ½
- äº‹ä»¶æŸ¥è¯¢æ€§èƒ½

### 3. å†…å­˜å’ŒCPUä½¿ç”¨æµ‹è¯•

æµ‹è¯•ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼š
- å†…å­˜å ç”¨
- CPUä½¿ç”¨ç‡
- ç¼“å­˜å‘½ä¸­ç‡

## æ€§èƒ½ä¼˜åŒ–å®ç°çŠ¶æ€

### âœ… å·²å®ç°çš„ä¼˜åŒ–

1. **SIMDä»·æ ¼æ¯”è¾ƒ** (AVX2)
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - æ‰¹é‡å¤§å°: 4ä¸ªä»·æ ¼/æ¬¡
   - æ–‡ä»¶: `include/core/simd_utils.h`

2. **Lock-Free SPSC Queue**
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - ç”¨é€”: äº‹ä»¶é˜Ÿåˆ—
   - æ–‡ä»¶: `include/core/lockfree_queue.h`

3. **å†…å­˜æ± **
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - ç±»å‹: Lock-Free Memory Pool
   - æ–‡ä»¶: `include/core/memory_pool.h`

4. **å¼‚æ­¥æŒä¹…åŒ–**
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - ä½¿ç”¨: Lock-Freeé˜Ÿåˆ—
   - æ–‡ä»¶: `include/core/persistence_async.h`

5. **NUMAå·¥å…·**
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - åŠŸèƒ½: çº¿ç¨‹ç»‘å®šã€å†…å­˜ç»‘å®š
   - æ–‡ä»¶: `include/core/numa_utils.h`

6. **ARTæ ‘**
   - å®ç°çŠ¶æ€: âœ… å·²å®ç°
   - æ›¿ä»£: çº¢é»‘æ ‘
   - æ–‡ä»¶: `include/core/art_tree.h`

### âš ï¸ éƒ¨åˆ†å®ç°çš„ä¼˜åŒ–

1. **Lock-Free Order Book**
   - å®ç°çŠ¶æ€: âš ï¸ éƒ¨åˆ†å®ç°
   - è¯´æ˜: OrderBookART ä»ä½¿ç”¨ mutex
   - æ–‡ä»¶: `include/core/orderbook_art.h`

### ğŸ’¡ è®¡åˆ’ä¸­çš„ä¼˜åŒ–

1. **AVX-512å‡çº§**
   - å½“å‰: AVX2 (4ä¸ªä»·æ ¼/æ¬¡)
   - è®¡åˆ’: AVX-512 (8-16ä¸ªä»·æ ¼/æ¬¡)

2. **å®Œå…¨æ— é”è®¢å•ç°¿**
   - å½“å‰: ä½¿ç”¨ mutex
   - è®¡åˆ’: å®Œå…¨æ— é”å®ç°

## æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•1: è®¢å•æ’®åˆå»¶è¿Ÿ

| è®¢å•ç±»å‹ | å¹³å‡å»¶è¿Ÿ (ns) | P50 (ns) | P99 (ns) | TPS |
|---------|--------------|----------|----------|-----|
| é™ä»·å•   | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |
| å¸‚ä»·å•   | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |
| æ‰¹é‡è®¢å• | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |

### æµ‹è¯•2: äº‹ä»¶æº¯æºæ€§èƒ½

| æ“ä½œç±»å‹ | å¹³å‡å»¶è¿Ÿ (ns) | P99 (ns) | ååé‡ |
|---------|--------------|----------|--------|
| äº‹ä»¶å†™å…¥ | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |
| äº‹ä»¶é‡æ”¾ | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |
| äº‹ä»¶æŸ¥è¯¢ | å¾…æµ‹è¯•       | å¾…æµ‹è¯•   | å¾…æµ‹è¯• |

### æµ‹è¯•3: ç³»ç»Ÿèµ„æºä½¿ç”¨

| æŒ‡æ ‡ | ç©ºé—²çŠ¶æ€ | å³°å€¼çŠ¶æ€ |
|-----|---------|---------|
| CPUä½¿ç”¨ç‡ | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   |
| å†…å­˜å ç”¨  | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   |
| ç¼“å­˜å‘½ä¸­ç‡ | å¾…æµ‹è¯•   | å¾…æµ‹è¯•   |

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### å½“å‰ç“¶é¢ˆ

1. **è®¢å•ç°¿é”ç«äº‰**
   - é—®é¢˜: OrderBookART ä½¿ç”¨ mutex
   - å½±å“: å¤šçº¿ç¨‹ç«äº‰æ—¶å»¶è¿Ÿå¢åŠ 
   - ä¼˜åŒ–: å®ç°å®Œå…¨æ— é”è®¢å•ç°¿

2. **SIMDæ‰¹é‡å¤§å°é™åˆ¶**
   - é—®é¢˜: å½“å‰åªæ”¯æŒ4ä¸ªä»·æ ¼/æ¬¡
   - å½±å“: æ‰¹é‡å¤„ç†æ•ˆç‡å—é™
   - ä¼˜åŒ–: å‡çº§åˆ°AVX-512æ”¯æŒ8-16ä¸ª

### ä¼˜åŒ–å»ºè®®

1. **çŸ­æœŸä¼˜åŒ–** (1-2å‘¨)
   - å®ç°å®Œå…¨æ— é”è®¢å•ç°¿
   - ä¼˜åŒ–å†…å­˜åˆ†é…è·¯å¾„

2. **ä¸­æœŸä¼˜åŒ–** (1-2æœˆ)
   - å‡çº§åˆ°AVX-512
   - å®ç°NUMAæ„ŸçŸ¥çš„è®¢å•ç°¿åˆ†åŒº

3. **é•¿æœŸä¼˜åŒ–** (3-6æœˆ)
   - DPDKç”¨æˆ·æ€ç½‘ç»œæ ˆ
   - FPGAç¡¬ä»¶åŠ é€Ÿ

## ç»“è®º

å½“å‰ç³»ç»Ÿå·²å®ç°å¤§éƒ¨åˆ†æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ï¼š
- âœ… SIMDä»·æ ¼æ¯”è¾ƒ (AVX2)
- âœ… Lock-Freeäº‹ä»¶é˜Ÿåˆ—
- âœ… å†…å­˜æ± 
- âœ… å¼‚æ­¥æŒä¹…åŒ–
- âœ… ARTæ ‘

ä¸»è¦å¾…ä¼˜åŒ–é¡¹ï¼š
- âš ï¸ å®Œå…¨æ— é”è®¢å•ç°¿
- ğŸ’¡ AVX-512å‡çº§

## é™„å½•

### æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
cd build
./test_production_performance

# è¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•
./full_chain_benchmark
```

### ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](PERFORMANCE_OPTIMIZATION_GUIDE.md)
- [æ€§èƒ½ä¼˜åŒ–ä¸€è‡´æ€§æŠ¥å‘Š](PERFORMANCE_OPTIMIZATION_CONSISTENCY_REPORT.md)
EOFREPORT

# æ›¿æ¢æ—¥æœŸ
sed -i '' "s/\$(date.*)/$(date '+%Y-%m-%d %H:%M:%S')/" "$REPORT_FILE"
sed -i '' "s/\$(sysctl.*)/$(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo 'Unknown')/" "$REPORT_FILE"
sed -i '' "s/\$(uname.*)/$(uname -s) $(uname -r)/" "$REPORT_FILE"
sed -i '' "s/\$(g++.*)/$(g++ --version | head -1)/" "$REPORT_FILE"

echo "âœ… æ€§èƒ½å‹æµ‹æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
cat "$REPORT_FILE"
