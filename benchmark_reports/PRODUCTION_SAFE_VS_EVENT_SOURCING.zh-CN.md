# Production Safe vs Event Sourcing 性能对比

## 概述

本报告对比了两个注重数据安全和可审计性的版本的性能特征：

- **production_safe**: 基于WAL的零数据丢失版本
- **event_sourcing**: 事件溯源模式实现

[English](PRODUCTION_SAFE_VS_EVENT_SOURCING.md) | [中文](PRODUCTION_SAFE_VS_EVENT_SOURCING.zh-CN.md)

## 测试配置

- **测试订单数**: 每个版本50,000单
- **测试环境**: Docker (Linux amd64)
- **编译器**: GCC，编译选项 `-O3 -flto -funroll-loops`
- **测试日期**: 2025-12-18

---

## 性能指标对比

| 指标 | production_safe | event_sourcing | 差异 |
|------|---------------|----------------|------|
| **吞吐量** | 9.78 K orders/sec | 418.80 K orders/sec | **event_sourcing快42.8倍** |
| **平均延迟** | 99.68 μs | 1.75 μs | **event_sourcing低56.9倍** |
| **P50延迟** | 78.17 μs | 1.54 μs | **event_sourcing低50.8倍** |
| **P90延迟** | 147.96 μs | 2.08 μs | **event_sourcing低71.2倍** |
| **P99延迟** | 397.00 μs | 3.08 μs | **event_sourcing低128.9倍** |
| **最小延迟** | 30.42 μs | 0.96 μs | **event_sourcing低31.7倍** |
| **最大延迟** | 46,788.50 μs | 2,344.33 μs | **event_sourcing低20.0倍** |
| **总交易数** | 12 | 10 | 交易执行相似 |
| **交易率** | 0.02% | 0.02% | 相同 |
| **错误数** | 0 | 0 | 均无错误 |

---

## 详细分析

### 吞吐量分析

**production_safe**: 9.78 K orders/sec
- 吞吐量较低，因为WAL（预写日志）开销
- 每个操作完成前必须写入磁盘
- 组提交优化有帮助，但仍存在显著开销

**event_sourcing**: 418.80 K orders/sec
- 内存事件存储带来更高吞吐量
- 事件异步存储，不阻塞撮合
- 针对高频交易场景优化

**性能差距**: event_sourcing每秒处理订单数多**42.8倍**

### 延迟分析

**production_safe**:
- 平均: 99.68 μs（接近100微秒）
- P99: 397.00 μs（接近400微秒）
- 高延迟源于同步WAL写入
- 磁盘I/O操作带来显著开销

**event_sourcing**:
- 平均: 1.75 μs（低于2微秒）
- P99: 3.08 μs（低于4微秒）
- 内存操作带来超低延迟
- 关键路径无磁盘I/O阻塞

**性能差距**: event_sourcing平均延迟低**56.9倍**

### 延迟分布

#### production_safe
- **P50**: 78.17 μs - 50%的订单在~78μs内完成
- **P90**: 147.96 μs - 90%的订单在~148μs内完成
- **P99**: 397.00 μs - 99%的订单在~397μs内完成
- **最大**: 46,788.50 μs - 偶发峰值可达~47ms

#### event_sourcing
- **P50**: 1.54 μs - 50%的订单在~1.5μs内完成
- **P90**: 2.08 μs - 90%的订单在~2μs内完成
- **P99**: 3.08 μs - 99%的订单在~3μs内完成
- **最大**: 2,344.33 μs - 最大延迟~2.3ms

**关键洞察**: event_sourcing延迟分布更紧密，尾部延迟极小。

---

## 功能对比

| 功能 | production_safe | event_sourcing |
|------|---------------|----------------|
| **数据安全** | ✅✅✅ 零数据丢失（WAL） | ✅✅ 事件重放能力 |
| **崩溃恢复** | ✅✅✅ 从WAL自动恢复 | ✅✅ 从日志重放事件 |
| **审计追踪** | ✅✅ WAL日志 | ✅✅✅ 完整事件历史 |
| **性能** | ⚠️ 较低（9.78K/s） | ✅✅✅ 高（418.80K/s） |
| **延迟** | ⚠️ 较高（99.68μs） | ✅✅✅ 超低（1.75μs） |
| **确定性** | ✅✅✅ 是 | ✅✅✅ 是（事件重放） |
| **适用场景** | 需要零数据丢失的金融系统 | 高频交易、审计要求 |

---

## 使用场景建议

### 选择 production_safe 当：
- **零数据丢失至关重要**（监管要求）
- **必须保证崩溃恢复**（金融系统）
- **吞吐量要求适中**（< 20K orders/sec）
- **延迟要求宽松**（> 50μs可接受）
- **合规和审计追踪**是强制要求

### 选择 event_sourcing 当：
- **超低延迟至关重要**（< 5μs）
- **需要高吞吐量**（> 300K orders/sec）
- **需要完整审计追踪**（事件历史）
- **确定性重放**很重要
- **内存性能**可接受
- **基于事件的架构**符合系统设计

---

## 性能权衡

### production_safe 权衡
- ✅ **优点**: 零数据丢失、保证持久化、崩溃恢复
- ❌ **缺点**: 吞吐量慢42.8倍、延迟高56.9倍、磁盘I/O开销

### event_sourcing 权衡
- ✅ **优点**: 吞吐量快42.8倍、延迟低56.9倍、完整审计追踪
- ❌ **缺点**: 需要单独的持久化策略、事件日志占用内存

---

## 技术实现差异

### production_safe
- **WAL机制**: 预写日志与组提交
- **持久化**: 操作完成前同步磁盘写入
- **恢复**: 启动时重放WAL条目
- **开销**: 关键路径上的磁盘I/O

### event_sourcing
- **事件存储**: 内存事件日志与异步持久化
- **持久化**: 异步事件日志（非阻塞）
- **恢复**: 从事件存储重放事件
- **开销**: 最小（内存操作）

---

## 结论

**对于高性能交易**:
- **event_sourcing** 明显胜出，吞吐量418.80K orders/sec，延迟1.75μs
- 适合速度关键的高频交易
- 通过事件历史提供完整审计追踪

**对于金融合规**:
- **production_safe** 提供零数据丢失保证
- 对于数据丢失不可接受的系统至关重要
- 对于中等吞吐量要求可接受的性能

**混合方案**:
考虑使用 **event_sourcing** 获得撮合引擎性能，同时使用 **production_safe** 风格的WAL处理关键状态变更，结合两种方案的优点。

---

## 相关报告

- [production_safe报告](./docker/production_safe_BENCHMARK_REPORT.md)
- [event_sourcing报告](./docker/event_sourcing_BENCHMARK_REPORT.md)
- [跨平台报告](./CROSS_PLATFORM_BENCHMARK_REPORT.md)

---

*报告基于Docker压测结果生成*



